<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Profil â€” SETRUM Dosen</title>
  <link rel="stylesheet" href="../CSS/editprofiledosen.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <aside class="sidebar">
    <div class="brand">SETRUM</div>
    <nav class="menu">
      <a href="home_dosen.html"><i class="fa fa-home"></i><span>Beranda</span></a>
      <a href="kelasdosen.html"><i class="fa fa-book"></i><span>Kelas</span></a>
      <a href="ProfileDosen.html" class="active"><i class="fa fa-user"></i><span>Profil</span></a>
      <a href="#" id="logoutBtn"><i class="fa fa-sign-out-alt"></i><span>Keluar</span></a>
    </nav>
  </aside>

  <main class="content">
    <div class="content-inner">
      <div class="top-row">
        <img id="profileImage" class="profile-pic" alt="Foto Profil">
        <div>
          <div class="profile-info">
            <p id="roleDisplay">Dosen | Teknik Informatika</p>
          </div>
          <div class="pic-controls">
            <label for="fotoInput" id="btnChangeSmall">Ganti foto profil</label>
            <input type="file" id="fotoInput" accept="image/*" style="display:none;">
            <button id="btnDeleteSmall">Hapus</button>
          </div>
        </div>
      </div>

      <div class="form-area">
        <label for="nama">Nama</label>
        <input type="text" id="nama">

        <label for="nip">NIP</label>
        <input type="text" id="nip">

        <label for="prodi">Program Studi yang Diampu</label>
        <input type="text" id="prodi">
      </div>

      <div class="actions">
        <button class="btn-cancel" id="btnCancel">Batal</button>
        <button class="btn-save" id="btnSave">Simpan Perubahan</button>
      </div>
    </div>
  </main>

  <!-- Popup logout -->
  <div class="logout-popup" id="logoutPopup">
    <h3>Logout</h3>
    <p>Apakah Anda yakin ingin keluar?</p>
    <button class="yes" id="yesLogout">Ya</button>
    <button class="cancel" id="cancelLogout">Batal</button>
  </div>

  <script>
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || (!loggedInUser.username && !loggedInUser.name)) {
      window.location.href = '/Mahasiswa/HTML/form_login.html';
    }

    const username = loggedInUser.username || loggedInUser.name || "guest";
    const profileKey = `profileDosen_${username}`;
    const imageKey = `profileImageDosen_${username}`;

    const profileImage = document.getElementById('profileImage');
    const nameInput = document.getElementById('nama');
    const nipInput = document.getElementById('nip');
    const prodiInput = document.getElementById('prodi');
    const roleDisplay = document.getElementById('roleDisplay');
    const fotoInputElement = document.getElementById('fotoInput');

    let newImageDataUrl = null;
    let deleteImageFlag = false;

    const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
    const savedImage = localStorage.getItem(imageKey);

    nameInput.value = profileData.nama || loggedInUser.name || '';
    nipInput.value = profileData.nip || '';
    prodiInput.value = profileData.prodi || 'Teknik Informatika';

    if (savedImage && savedImage.trim() !== "") {
      profileImage.src = savedImage;
    } else {
      profileImage.src = "";
    }

    roleDisplay.textContent = 'Dosen | ' + (prodiInput.value || 'Teknik Informatika');

    fotoInputElement.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        profileImage.src = dataUrl;
        newImageDataUrl = dataUrl;
        deleteImageFlag = false;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('btnDeleteSmall').addEventListener('click', () => {
      profileImage.src = ""; // kosongkan src
      newImageDataUrl = null;
      deleteImageFlag = true;
    });

    document.getElementById('btnCancel').addEventListener('click', () => {
      window.location.href = 'ProfileDosen.html';
    });

    document.getElementById('btnSave').addEventListener('click', () => {
      const dataToSave = {
        nama: nameInput.value.trim(),
        nip: nipInput.value.trim(),
        prodi: prodiInput.value.trim()
      };
      localStorage.setItem(profileKey, JSON.stringify(dataToSave));

      if (newImageDataUrl) {
        localStorage.setItem(imageKey, newImageDataUrl);
      } else if (deleteImageFlag) {
        localStorage.removeItem(imageKey);
      }

      alert("Perubahan disimpan!");
      window.location.href = 'ProfileDosen.html';
    });

    // === LOGOUT POPUP ===
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutPopup = document.getElementById('logoutPopup');
    const yesLogout = document.getElementById('yesLogout');
    const cancelLogout = document.getElementById('cancelLogout');

    logoutBtn.onclick = () => logoutPopup.style.display = 'block';
    cancelLogout.onclick = () => logoutPopup.style.display = 'none';
    yesLogout.onclick = () => {
      localStorage.removeItem("loggedInUser");
      logoutPopup.style.display = 'none';
      window.location.href = '../../Mahasiswa/HTML/form_login.html';
    };
  </script>
</body>
</html>
