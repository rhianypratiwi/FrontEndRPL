<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Profil â€” SETRUM Dosen</title>
  <link rel="stylesheet" href="../CSS/editprofiledosen.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  
</head>
<body>
  <aside class="sidebar">
    <div class="brand">SETRUM</div>
    <nav class="menu">
      <a href="home_dosen.html"><i class="fa fa-home"></i><span>Beranda</span></a>
      <a href="ProfileDosen.html" class="active"><i class="fa fa-user"></i><span>Profil</span></a>
            <a href="kelasdosen.html"><i class="fa fa-book"></i><span>Kelas</span></a>
      <a href="#" id="logoutBtn"><i class="fa fa-sign-out-alt"></i><span>Keluar</span></a>
    </nav>
  </aside>

  <main class="content">
    <div class="content-inner">
      <div class="top-row">
        <img id="profileImage" class="profile-pic" src="https://i.pravatar.cc/150" alt="Foto Profil">
        <div>
          <div class="profile-info">
            <p id="roleDisplay">Dosen | Teknik Informatika</p>
          </div>
          <div class="pic-controls">
                        <label for="fotoInput" id="btnChangeSmall">Ganti foto profil</label>
            <input type="file" id="fotoInput" accept="image/*" style="display: none;">
            <button id="btnDeleteSmall">Hapus</button>
          </div>
        </div>
      </div>

      <div class="form-area">
        <label for="nama">Nama</label>
        <input type="text" id="nama">

        <label for="nip">NIP</label>
        <input type="text" id="nip">

        <label for="prodi">Program Studi yang Diampu</label>
        <input type="text" id="prodi">
      </div>

      <div class="actions">
        <button class="btn-cancel" id="btnCancel">Batal</button>
        <button class="btn-save" id="btnSave">Simpan Perubahan</button>
      </div>
    </div>
  </main>

  <!-- Popup logout -->
  <div class="logout-popup" id="logoutPopup">
    <h3>Logout</h3>
    <p>Apakah Anda yakin ingin keluar?</p>
    <button class="yes" id="yesLogout">Ya</button>
    <button class="cancel" id="cancelLogout">Batal</button>
  </div>

    <script>
    // === SCRIPT DIPERBAIKI TOTAL ===

    // 1. Cek Login & Ambil Kunci Penyimpanan
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || (!loggedInUser.username && !loggedInUser.name)) {
      window.location.href = 'form_login.html';
    }

    const username = loggedInUser.username || loggedInUser.name || "guest";
    const profileKey = `profileDosen_${username}`;
    const imageKey = `profileImageDosen_${username}`;

    // 2. Ambil Referensi Elemen HTML (SESUAIKAN DENGAN HTML ANDA)
    const profileImage = document.getElementById('profileImage');
    const nameInput = document.getElementById('nama');
    const nipInput = document.getElementById('nip'); // DIGANTI DARI 'nimInput'
    const prodiInput = document.getElementById('prodi'); // DIGANTI DARI 'kelasInput'
    const roleDisplay = document.getElementById('roleDisplay');
    const fotoInputElement = document.getElementById('fotoInput');

    // Variabel sementara untuk foto baru
    let newImageDataUrl = null;
    let deleteImageFlag = false;

    // 3. Muat Data yang Ada ke Form
    const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
    const savedImage = localStorage.getItem(imageKey);

    nameInput.value = profileData.nama || loggedInUser.name || '';
    nipInput.value = profileData.nip || ''; // DIGANTI DARI 'nim'
    prodiInput.value = profileData.prodi || 'Teknik Informatika'; // DIGANTI DARI 'kelas'

    if (savedImage) {
      profileImage.src = savedImage;
    } else {
      profileImage.src = "https://i.pravatar.cc/150";
    }
    
    // Set Teks Role (Dosen, bukan Mahasiswa)
    roleDisplay.textContent = 'Dosen | ' + (prodiInput.value || 'Teknik Informatika');


    // 4. Fungsikan Tombol Ganti Foto
    fotoInputElement.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        profileImage.src = dataUrl; // Tampilkan preview
        newImageDataUrl = dataUrl; // Simpan data URL untuk 'Simpan'
        deleteImageFlag = false; // Batalkan flag hapus jika ada
      };
      
      reader.readAsDataURL(file);
    });
    
    // (Tambahkan listener ke tombol <label> jika diperlukan, tapi 'for' sudah cukup)
    // document.getElementById('btnChangeSmall').addEventListener('click', () => {
    //     fotoInputElement.click(); // Memicu input file tersembunyi
    // });


    // 5. Fungsikan Tombol Hapus Foto
    document.getElementById('btnDeleteSmall').addEventListener('click', () => {
      profileImage.src = "https://i.pravatar.cc/150"; // Reset preview
      newImageDataUrl = null; // Hapus data URL baru
      deleteImageFlag = true; // Set flag untuk dihapus saat simpan
    });

    // 6. Fungsikan Tombol Batal
    document.getElementById('btnCancel').addEventListener('click', () => {
      window.location.href = 'ProfileDosen.html'; // PERBAIKI NAMA FILE
    });

    // 7. Fungsikan Tombol Simpan
    document.getElementById('btnSave').addEventListener('click', () => {
      // Ambil data yang ada
      const currentProfileData = JSON.parse(localStorage.getItem(profileKey)) || {};

      // Update data dengan nilai form
      const dataToSave = {
        nama: nameInput.value.trim(),
        nip: nipInput.value.trim(), // DIGANTI DARI 'nim'
        prodi: prodiInput.value.trim() // DIGANTI DARI 'kelas'
      };
      
      // Simpan data teks ke profileKey
      localStorage.setItem(profileKey, JSON.stringify(dataToSave));
      
      // Cek dan simpan data foto
      if (newImageDataUrl) {
        // Jika ada foto baru, simpan
        localStorage.setItem(imageKey, newImageDataUrl);
      } else if (deleteImageFlag) {
        // Jika flag hapus aktif, hapus foto
        localStorage.removeItem(imageKey);
      }
      // Jika tidak keduanya, foto lama tidak diubah

      alert("Perubahan disimpan!");
      window.location.href = 'ProfileDosen.html'; // PERBAIKI NAMA FILE
    });

    // 8. Fungsikan Logout (Kode Anda sudah benar)
     // Logout
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutPopup = document.getElementById('logoutPopup');
    const yesLogout = document.getElementById('yesLogout');
    const cancelLogout = document.getElementById('cancelLogout');

    logoutBtn.onclick = () => logoutPopup.style.display = 'block';
    cancelLogout.onclick = () => logoutPopup.style.display = 'none';
    yesLogout.onclick = () => {
      logoutPopup.style.display = 'none';
      window.location.href = '../../form_login.html';
    };
  </script>
</body>
</html>