<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail Kelas â€” SETRUM</title>
  <link rel="stylesheet" href="../CSS/postingandosen.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
 
</head>
<body>
  <aside class="sidebar">
    <div class="brand">SETRUM</div>
    <nav class="menu">
      <a href="home_dosen.html"><i class="fa fa-home"></i> Beranda</a>
      <a href="ProfileDosen.html"><i class="fa fa-user"></i> Profil</a>
      <a href="kelasdosen.html" class="active"><i class="fa fa-book"></i> Kelas</a>
      <a href="#" id="logoutBtn"><i class="fa fa-sign-out-alt"></i> Keluar</a>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <h2 id="titleClass">Kelas</h2>
      <div class="profile-section">
        <div class="profile-text">
          <h1 id="greetName">Selamat mengajar, Lia!</h1>
          <p id="todayDate"></p>
        </div>
        <div class="profile">
          <img src="https://i.pravatar.cc/100" alt="profil" id="profilePhoto">
        </div>
      </div>
    </div>

    <div id="classInfo" class="kelas-info"></div>

    <div class="actions">
      <button id="btnBuatTugas">Buat Tugas</button>
      <input type="text" id="announceInput" placeholder="Umumkan sesuatu â€¦">
      <button id="btnKirim" class="kirim">Kirim</button>
    </div>

    <div class="post-list" id="postList"></div>
  </main>

    <div class="logout-popup" id="logoutPopup">
    <h3>Logout</h3>
    <p>Apakah Anda yakin ingin keluar?</p>
    <button class="yes" id="yesLogout">Ya</button>
    <button class="cancel" id="cancelLogout">Batal</button>
  </div>

  <script>
    // === AWAL LOGIKA HEADER ===
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || !loggedInUser.name) {
      window.location.href = 'form_login.html';
    }

    const username = loggedInUser.username || loggedInUser.name || "guest";
    const profileKey = 'profileDosen_' + username;
    const imageKey = 'profileImageDosen_' + username;

    const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
    const savedImage = localStorage.getItem(imageKey);
    // === AKHIR LOGIKA HEADER ===
  
    // Ambil data kelas yang dipilih
    const selected = JSON.parse(localStorage.getItem("selectedClass")) || { nama:"Kelas", jumlah:"", waktu:"" };
    document.getElementById("titleClass").textContent = selected.nama;
    document.getElementById("classInfo").innerHTML = '<strong>' + selected.nama + '</strong><br>' + selected.jumlah + '<br>' + selected.waktu;

    // Elemen DOM utama
    const greetNameEl = document.getElementById("greetName");
    const todayDateEl = document.getElementById("todayDate");
    const inputAnn = document.getElementById("announceInput");
    const postListEl = document.getElementById("postList");

    // Ambil nama dosen dari localStorage (saat login)
    const namaDosen = (profileData && profileData.nama) ? profileData.nama : loggedInUser.name;

    // Tanggal hari ini
    const today = new Date();
    const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric' };
    todayDateEl.textContent = today.toLocaleDateString('id-ID', opts);
  
    // JAVASCRIPT: Teks sapaan diperbaiki (pakai +)
    greetNameEl.textContent = 'Selamat mengajar, ' + namaDosen + '!';

  
    const profilePhoto = document.getElementById("profilePhoto");
    if (savedImage) {
      profilePhoto.src = savedImage;
    } else {
      profilePhoto.src = "https://i.pravatar.cc/100"; // Foto default
    }
 

    // Ambil postingan per kelas
    let posts = JSON.parse(localStorage.getItem("posts_" + selected.nama)) || [];

    // ðŸ”¹ Render semua postingan
    function renderPosts(){
      postListEl.innerHTML = '';
      posts.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = 'post';
        // DIPERBAIKI: Menggunakan + agar tidak merah
        div.innerHTML = 
          '<div class="info">' +
            '<div class="avatar"></div>' +
            '<div class="info-text">' +
              '<strong>' + namaDosen + '</strong><br>' +
              '<small>' + p.tanggal + '</small>' +
              '<p class="isi-post">' + p.text + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="actions-post">' +
            '<i class="fa fa-ellipsis-v" onclick="toggleMenu(this, ' + i + ')"></i>' +
            '<button class="deleteBtn" style="display:none;" onclick="deletePost(' + i + ')">Hapus</button>' +
          '</div>';
        postListEl.appendChild(div);
      });
    }

    // ðŸ”¹ Tampilkan/sembunyikan tombol hapus
    function toggleMenu(el, idx){
      const btn = el.nextElementSibling;
       btn.style.display = btn.style.display === 'block' ? 'none' : 'block';
    }

    // ðŸ”¹ Hapus postingan
    function deletePost(idx){
      posts.splice(idx, 1);
      localStorage.setItem("posts_" + selected.nama, JSON.stringify(posts));
      renderPosts();
    }

    // ðŸ”¹ Kirim pengumuman baru
    function tambahPost(){
      const text = inputAnn.value.trim();
      if (!text) return alert("Tulis pengumumannya dulu!");
      const newPost = { 
        text, 
        tanggal: new Date().toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric'}) 
      };
      posts.unshift(newPost);
      localStorage.setItem("posts_" + selected.nama, JSON.stringify(posts));
      inputAnn.value = '';
      renderPosts();
    }

    // ðŸ”¹ Event tombol
    document.getElementById("btnBuatTugas").addEventListener("click", () => {
      window.location.href = "buattugas.html";
    });

    const btnKirim = document.getElementById("btnKirim");
    if (btnKirim) btnKirim.addEventListener("click", tambahPost);


    //  Render awal
    renderPosts();

    // JAVASCRIPT POPUP DITAMBAHKAN
    // === LOGOUT SCRIPT ===
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutPopup = document.getElementById('logoutPopup');
    const yesLogout = document.getElementById('yesLogout');
    const cancelLogout = document.getElementById('cancelLogout');

    if (logoutBtn && logoutPopup && yesLogout && cancelLogout) {
      
      logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        logoutPopup.style.display = "block";
      });
      
      cancelLogout.addEventListener("click", () => {
        logoutPopup.style.display = "none";
      });
      
      yesLogout.addEventListener("click", () => {
        localStorage.removeItem('loggedInUser'); 
        logoutPopup.style.display = 'none';
        window.location.href = '../../form_login.html'; 
      });
    }
    // === AKHIR LOGOUT SCRIPT ===
  </script>

</body>
</html>